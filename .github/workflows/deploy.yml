---
name: Deploy Action

on:
  workflow_call:
    inputs:
      #branch:
      #  required: true
      #  type: string
      namespace:
        required: true
        type: string
      user_name:
        required: false
        default: spsh-bot
        type: string
      dbildungs_iam_server_branch:
        required: true
        description: "Has to be main or in format <project>-<ticketnumber>, e.g. spsh-130"
        default: main
        type: string
      dbildungs_iam_client_branch:
        required: true
        description: "Has to be main or in format <project>-<ticketnumber>, e.g. spsh-130"
        default: main
        type: string
      dbildungs_iam_keycloak_branch:
        required: true
        description: "Has to be main or in format <project>-<ticketnumber>, e.g. spsh-130"
        default: main
        type: string
    secrets:
      SPSH_DEV_KUBECONFIG:
        required: true
permissions:
  contents: read

jobs:     
  deployment:
    runs-on: 'ubuntu-latest'
    env:
      GITHUB_TOKEN: ${{ github.token }}
      KUBECONFIG_FILE: '${{ secrets.SPSH_DEV_KUBECONFIG }}'
    steps:
      # Search for dbildungs-iam-server Helm Chart
      - name: Search dbildungs-iam-server  Helm Chart release by ticket name
        id: get_dbildungs_iam_server_helm_chart_tag
        uses: dBildungsplattform/spsh-app-deploy/.github/workflows/find-helm-chart-by-ticket-or-main-in-registry.yml@main
        with:
          github_repository: "dBildungsplattform/helm-charts-registry"
          branch: ${{ inputs.dbildungs_iam_server_branch }}
          chart_name: "dbildungs-iam"
          service_name: "dbildungs-iam-server"

      # Search for dbildungs-iam-cleint Helm Chart

      - name: Set up kubectl and Helm
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig as tmp file
        run: |
          echo "${{ secrets.SPSH_DEV_KUBECONFIG }}" > kubeconfig
          export KUBECONFIG=$(pwd)/kubeconfig

      - name: Create Kubernetes namespace
        run: |
          kubectl create namespace ${{ inputs.namespace }} --kubeconfig $(pwd)/kubeconfig || true

      - name: Download dbildungs_iam_server Helm chart
        run: |
          wget https://github.com/dBildungsplattform/helm-charts-registry/releases/download/$dbildungs_iam_server_tagname/$dbildungs_iam_server_tagname.tgz
          tar -zxvf $dbildungs_iam_server_tagname.tgz

      # - name: Download dbildungs_iam_client Helm chart
      #   run: |
      #     wget https://github.com/dBildungsplattform/helm-charts-registry/releases/download/$dbildungs_iam_client_tagname/$dbildungs_iam_client_tagname.tgz
      #     tar -zxvf $dbildungs_iam_client_tagname.tgz

      # - name: Deploy dbildungs_iam_client Helm chart
      #   run: |
      #     helm upgrade --install \
      #       dbildungs-iam-client \
      #       dbildungs-iam-client \
      #       --namespace ${{ inputs.namespace }} \
      #       --kubeconfig $(pwd)/kubeconfig \
      #       --set backendHostname=${{ inputs.namespace }}.dev.spsh.dbildungsplattform.de

      - name: Deploy dbildungs_iam_server Helm chart
        run: |
          helm upgrade --install \
            dbildungs-iam \
            dbildungs-iam \
            --namespace ${{ inputs.namespace }} \
            --kubeconfig $(pwd)/kubeconfig \
            --set backendHostname=${{ inputs.namespace }}.dev.spsh.dbildungsplattform.de